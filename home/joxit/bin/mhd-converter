#!/bin/bash
if [ ! -f "$1" ]; then
  echo "$1 is not a file"
  exit 1
fi
if [ -z "$2" ]; then
  echo "please chose an output"
  exit 1
fi
export LANG=en-gb

MKV="$1"
OUTPUT="$2"


if [ "$ENCODER" = "x265" ]; then
  ENCODER_OPTS="wpp:ctu=64:min-cu-size=8:max-tu-size=32:tu-intra-depth=1:tu-inter-depth=1:me=1:subme=2:merange=57:no-rect:no-amp:max-merge=2:temporal-mvp:no-early-skip:rdpenalty=0:no-tskip:no-tskip-fast:strong-intra-smoothing:no-lossless:no-cu-lossless:no-constrained-intra:no-fast-intra:open-gop:no-temporal-layers:interlace=0:keyint=250:min-keyint=23:scenecut=40:rc-lookahead=20:lookahead-slices=0:bframes=4:bframe-bias=0:b-adapt=2:ref=3:limit-refs=0:no-limit-modes:weightp:no-weightb:aq-mode=1:qg-size=32:aq-strength=1.00:cbqpoffs=0:crqpoffs=0:rd=3:psy-rd=0.30:rdoq-level=0:psy-rdoq=0.00:signhide:deblock:sao:no-sao-non-deblock:b-pyramid:cutree:no-intra-refresh:rc=crf:crf=25.0:qcomp=0.60:qpmin=0:qpmax=51:qpstep=4:ipratio=1.40:pbratio=1.30"
else
  ENCODER="x264"
  ENCODER_OPTS="ref=6:subq=7:trellis=0:bframes=3:b-adapt=2:direct=auto:me=umh:merange=16:analyse=all:open-gop=0:rc-lookahead=50:level=4.1:no-fast-pskip=1:no-mixed-refs=0:no-weightb=0:no-mbtree=0:partitions=all"
fi

NB_AUDIO="$(mediainfo "$MKV" | grep -c "^Audio$")"
NB_VIDEO="$(mediainfo "$MKV" | grep -c "^Video$")"
NB_SUBTITLES="$(mediainfo "$MKV" | grep -c "^Text$")"
HEIGHT="$(mediainfo "$MKV" | grep -E "Height\s+:" | grep -oE "[0-9]+" )"
MODIFICATION_DATE="$(date --date @"$(stat "$MKV" --format="%Y")" "+%y%m%d%H%M.%S")"
echo "Your MKV contains $NB_VIDEO video; $NB_AUDIO audio; $NB_SUBTITLES subtitles"
echo "The video is in ${HEIGHT}p"
echo "Modification date is $MODIFICATION_DATE"
TMP="$(mktemp)"

set -ex
echo "Create mkv audio and video"
HandBrakeCLI \
  -i $MKV \
  --encoder "$ENCODER" \
  --two-pass \
  --turbo \
  --decomb \
  --loose-anamorphic \
  --rate 23.976 \
  --pfr \
  --encopts "$ENCODER_OPTS" \
  --all-audio \
  -o $TMP

echo "Retrieve subtitles"
mkvmerge -o "$OUTPUT" -S -B $TMP -D -A "$MKV"

touch -t "$MODIFICATION_DATE" "$OUTPUT"

rm $TMP
