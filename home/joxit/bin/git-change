#!/bin/bash
#    Copyright (C) 2015 Joxit
#
#    This program is free software: you can redistribute it and/or modify
#    it under the terms of the GNU General Public License as published by
#    the Free Software Foundation, either version 3 of the License, or
#    (at your option) any later version.
#
#    This program is distributed in the hope that it will be useful,
#    but WITHOUT ANY WARRANTY; without even the implied warranty of
#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#    GNU General Public License for more details.
#
#    You should have received a copy of the GNU General Public License
#    along with this program.  If not, see <http://www.gnu.org/licenses/>.
#

for arg in "$@"; do
  case "$arg" in
    --old-name=*)
      OLD_NAME="${arg#*=}"
      ;;
    --old-email=*)
      OLD_EMAIL="${arg#*=}"
      ;;
    --name=*)
      CORRECT_NAME="${arg#*=}"
      ;;
    --email=*)
      CORRECT_EMAIL="${arg#*=}"
      ;;
    -v|--version)
      echo "$0  Copyright (C) 2015 Joxit"
      echo "This program comes with ABSOLUTELY NO WARRANTY."
      echo "This is free software, and you are welcome to redistribute it"
      echo "under certain condition."
      exit 0
      ;;
  esac
  shift
done

git filter-branch -f --env-filter '
if [ "$GIT_COMMITTER_NAME" = "$OLD_NAME" ] || [ "$GIT_COMMITTER_EMAIL" = "$OLD_EMAIL" ]; then
  if [ $CORRECT_NAME ]; then
    export GIT_COMMITTER_NAME="$CORRECT_NAME"
  fi
  if [ $CORRECT_EMAIL ]; then
    export GIT_COMMITTER_EMAIL="$CORRECT_EMAIL"
  fi
fi
if [ "$GIT_AUTHOR_NAME" = "$OLD_NAME" ] || [ "$GIT_AUTHOR_EMAIL" = "$OLD_EMAIL" ]; then
  if [ $CORRECT_NAME ]; then
    export GIT_AUTHOR_NAME="$CORRECT_NAME"
  fi
  if [ $CORRECT_EMAIL ]; then
    export GIT_AUTHOR_EMAIL="$CORRECT_EMAIL"
  fi
fi
' --tag-name-filter cat -- --branches --tags
